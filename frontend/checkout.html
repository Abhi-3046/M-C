<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - M&C E-Commerce</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">M&C Store</div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="products.html">Products</a></li>
                <li class="cart-badge">
                    <a href="cart.html">ðŸ›’ Cart</a>
                    <span class="badge" style="display: none;">0</span>
                </li>
                <li class="auth-links">
                    <a href="profile.html">Profile</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container section">
        <h1 class="text-center mb-2">Checkout</h1>

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; align-items: start;">
            <!-- Checkout Form -->
            <div class="glass-card">
                <h2 style="margin-bottom: 1.5rem;">Shipping Information</h2>

                <div id="errorMessage" class="alert alert-error hidden"></div>

                <form id="checkoutForm">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="fullName" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="phone" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Shipping Address</label>
                        <textarea class="form-textarea" id="address" rows="4" required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Payment Method</label>
                        <select class="form-select" id="paymentMethod">
                            <option value="cod">Cash on Delivery</option>
                            <option value="online">Online Payment (Coming Soon)</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                        Place Order
                    </button>
                </form>
            </div>

            <!-- Order Summary -->
            <div class="glass-card" style="position: sticky; top: 100px;">
                <h2 style="margin-bottom: 1.5rem;">Order Summary</h2>

                <div id="orderItems" style="margin-bottom: 1.5rem; max-height: 300px; overflow-y: auto;"></div>

                <div
                    style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Subtotal</span>
                        <span id="subtotal">â‚¹0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Shipping</span>
                        <span style="color: var(--success);">FREE</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Tax (18%)</span>
                        <span id="tax">â‚¹0.00</span>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: 700;">
                    <span>Total</span>
                    <span id="total"
                        style="background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">â‚¹0.00</span>
                </div>
            </div>
        </div>
    </div>

    <footer
        style="background: rgba(21, 25, 50, 0.8); padding: 3rem 0; margin-top: 4rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
        <div class="container text-center">
            <div class="logo" style="margin-bottom: 1rem; font-size: 2rem;">M&C Store</div>
            <p style="margin-bottom: 1rem;">Your trusted partner for premium devices</p>
            <p style="color: var(--text-secondary); font-size: 0.875rem;">Â© 2026 M&C E-Commerce. All rights reserved.
            </p>
        </div>
    </footer>

    <script src="js/app.js"></script>
    <script>
        // Redirect if not logged in
        if (!isLoggedIn()) {
            window.location.href = 'login.html?redirect=checkout';
        }

        // Pre-fill user data
        const user = getUser();
        if (user) {
            document.getElementById('fullName').value = user.full_name || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('address').value = user.address || '';
        }

        function renderOrderSummary() {
            const cartItems = cart.cart;
            const itemsContainer = document.getElementById('orderItems');

            if (cartItems.length === 0) {
                window.location.href = 'cart.html';
                return;
            }

            itemsContainer.innerHTML = cartItems.map(item => {
                const price = item.discount_price || item.price;
                return `
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                        <img src="${item.image_url}" alt="${item.name}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 0.5rem;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 0.9rem;">${item.name}</div>
                            <div style="color: var(--text-secondary); font-size: 0.875rem;">Qty: ${item.quantity}</div>
                        </div>
                        <div style="font-weight: 700; color: var(--accent-cyan);">
                            ${formatPrice(price * item.quantity)}
                        </div>
                    </div>
                `;
            }).join('');

            const subtotal = cart.getTotal();
            const tax = subtotal * 0.18;
            const total = subtotal + tax;

            document.getElementById('subtotal').textContent = formatPrice(subtotal);
            document.getElementById('tax').textContent = formatPrice(tax);
            document.getElementById('total').textContent = formatPrice(total);
        }

        document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const fullName = document.getElementById('fullName').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const errorDiv = document.getElementById('errorMessage');

            errorDiv.classList.add('hidden');

            const shippingAddress = `${fullName}\n${phone}\n${address}`;

            try {
                const result = await apiCall('/orders', 'POST', {
                    shipping_address: shippingAddress,
                    payment_method: paymentMethod
                }, true);

                // Clear cart
                cart.clearCart();

                showNotification('Order placed successfully!', 'success');

                setTimeout(() => {
                    window.location.href = `profile.html?order=${result.order_id}`;
                }, 1500);
            } catch (error) {
                errorDiv.textContent = error.message || 'Failed to place order';
                errorDiv.classList.remove('hidden');
            }
        });

        renderOrderSummary();
    </script>

    <style>
        @media (max-width: 768px) {
            .container>div {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</body>

</html>